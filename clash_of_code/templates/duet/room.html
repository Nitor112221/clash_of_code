{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block content %}
<div class="container-fluid mt-3">
    <div class="row">
        <div class="col-md-12">
            <div class="card mb-3">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">{{ object.name }} ({{ object.language }})</h4>
                    <div>
                        {% with participants_count=room.prefetched_participants|length %}
                        <span class="badge bg-light text-dark me-2">
                            <i class="bi bi-people-fill"></i> {{ participants_count }}
                        </span>
                        {% endwith %}
                        {% if other_user %}
                        <span class="badge bg-info text-dark">
                            <i class="bi bi-person-fill"></i> {{ other_user.username }}
                        </span>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="editor" style="height: 70vh; width: 100%;">{{ object.content }}</div>
                </div>
                <div class="card-footer bg-light">
                    <div class="d-flex justify-content-between">
                        <div>
                            <a href="{% url 'duet:invite_user' object.id %}" class="btn btn-sm btn-outline-primary me-2">
                                <i class="bi bi-person-plus"></i> {% translate "Invite user" %}
                            </a>
                            <button id="save-btn" class="btn btn-sm btn-success">
                                <i class="bi bi-save"></i> {% translate "Save" %}
                            </button>
                            {% if object.owner == request.user %}
                                <a href="{% url 'duet:room_delete' object.id %}" class="btn btn-sm btn-outline-danger me-2">
                                    <i class="bi bi-trash"></i> {% translate "Delete" %}
                                </a>
                            {% endif %}
                        </div>
                        <div>
                            <a href="{% url 'duet:user_rooms' %}" class="btn btn-sm btn-outline-secondary">
                                <i class="bi bi-list-ul"></i> {% translate "My rooms" %}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
<script>
    const roomData = {
        id: {{ object.id }},
        languageMode: "{{ object.language.ace_mode }}",
        saveUrl: "{% url 'duet:save_room_content' object.id %}",
        username: "{{ request.user.username }}",
        csrfToken: "{{ csrf_token }}"
    };
    const socket = new WebSocket(
        `ws://${window.location.host}/ws/code_room/${roomData.id}/`
    );
</script>
<script src="{% static 'js/room.js' %}"></script>

<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="saveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-success text-white">
            <strong class="me-auto">{% translate "Success" %}</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
            {% translate "Code saved successfully!" %}
        </div>
    </div>
</div>
{% endblock %}
